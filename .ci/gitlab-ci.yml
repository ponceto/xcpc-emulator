#
# .gitlab-ci.yml - Copyright (c) 2001-2026 - Olivier Poncet
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

# ----------------------------------------------------------------------------
# default
# ----------------------------------------------------------------------------

default:
  image: debian:stable

# ----------------------------------------------------------------------------
# stages
# ----------------------------------------------------------------------------

stages:
  - tarball
  - build

# ----------------------------------------------------------------------------
# build-tarball
# ----------------------------------------------------------------------------

build-tarball:
  stage: tarball
  tags:
    - docker
    - amd64
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "release"
  before_script:
    - ./.ci/ci-setup-debian.sh
  script:
    - ./.ci/ci-build-tarball.sh
  artifacts:
    name: "xcpc-sources"
    paths:
      - ./*.tar.gz

# ----------------------------------------------------------------------------
# build-binary-amd64
# ----------------------------------------------------------------------------

build-binary-amd64:
  stage: build
  dependencies:
    - build-tarball
  tags:
    - docker
    - amd64
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "release"
  before_script:
    - ./.ci/ci-setup-debian.sh
  script:
    - ./.ci/ci-build-binary.sh
  artifacts:
    name: "xcpc-binary-amd64"
    paths:
      - ./*.tar.gz

# ----------------------------------------------------------------------------
# build-debian-amd64
# ----------------------------------------------------------------------------

build-debian-amd64:
  image: debian:bookworm
  stage: build
  dependencies:
    - build-tarball
  tags:
    - docker
    - amd64
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "release"
  before_script:
    - ./.ci/ci-setup-debian.sh
  script:
    - ./.ci/ci-build-debian.sh
  artifacts:
    name: "xcpc-debian-amd64"
    paths:
      - ./_build/*.tar.gz
      - ./_build/*.tar.xz
      - ./_build/*.buildinfo
      - ./_build/*.changes
      - ./_build/*.dsc
      - ./_build/*.deb

# ----------------------------------------------------------------------------
# build-debian-arm64
# ----------------------------------------------------------------------------

build-debian-arm64:
  image: debian:bookworm
  stage: build
  dependencies:
    - build-tarball
  tags:
    - docker
    - arm64
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "release"
  before_script:
    - ./.ci/ci-setup-debian.sh
  script:
    - ./.ci/ci-build-debian.sh
  artifacts:
    name: "xcpc-debian-arm64"
    paths:
      - ./_build/*.tar.gz
      - ./_build/*.tar.xz
      - ./_build/*.buildinfo
      - ./_build/*.changes
      - ./_build/*.dsc
      - ./_build/*.deb

# ----------------------------------------------------------------------------
# End-Of-File
# ----------------------------------------------------------------------------
